name: Release

on:
  push:
    tags: ["v*"]

permissions:
  contents: write
  id-token: write # For sigstore signing

jobs:
  build:
    name: Build (${{ matrix.name }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - { os: macos-latest, target: aarch64-apple-darwin, name: "macOS-arm64" }
          - { os: macos-latest, target: x86_64-apple-darwin, name: "macOS-x86_64" }
          - { os: ubuntu-latest, target: x86_64-unknown-linux-gnu, name: "Linux-x86_64" }
          - { os: ubuntu-latest, target: aarch64-unknown-linux-gnu, name: "Linux-aarch64" }
          - { os: windows-latest, target: x86_64-pc-windows-msvc, name: "Windows-x86_64" }
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (Linux aarch64)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu
          echo "CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc" >> $GITHUB_ENV

      - name: Build release binary
        run: cargo build --release --locked --target ${{ matrix.target }} -p tirith

      - name: Generate completions and man page (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist/completions dist/man
          ./target/${{ matrix.target }}/release/tirith completions bash > dist/completions/tirith.bash
          ./target/${{ matrix.target }}/release/tirith completions zsh > dist/completions/_tirith
          ./target/${{ matrix.target }}/release/tirith completions fish > dist/completions/tirith.fish
          ./target/${{ matrix.target }}/release/tirith manpage > dist/man/tirith.1

      - name: Generate completions (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir dist\completions
          .\target\${{ matrix.target }}\release\tirith.exe completions powershell > dist\completions\tirith.ps1

      - name: Package (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p dist/shell/lib
          cp target/${{ matrix.target }}/release/tirith dist/
          cp shell/tirith.sh dist/shell/
          cp shell/lib/* dist/shell/lib/
          cd dist && tar czf ../tirith-${{ matrix.name }}.tar.gz .

      - name: Package (Windows)
        if: runner.os == 'Windows'
        run: |
          mkdir dist\shell\lib
          copy target\${{ matrix.target }}\release\tirith.exe dist\
          copy shell\lib\powershell-hook.ps1 dist\shell\lib\
          cd dist && Compress-Archive -Path * -DestinationPath ..\tirith-${{ matrix.name }}.zip

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: tirith-${{ matrix.name }}
          path: tirith-${{ matrix.name }}.*

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          merge-multiple: true

      - name: Generate checksums
        run: |
          cd artifacts
          sha256sum tirith-* > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Sign with cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign checksums
        run: |
          cd artifacts
          cosign sign-blob --yes SHA256SUMS.txt --bundle SHA256SUMS.txt.bundle

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          files: |
            artifacts/*

  publish:
    name: Publish to crates.io
    needs: release
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Publish tirith-core
        run: cargo publish -p tirith-core --locked
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

      - name: Wait for crates.io index
        run: sleep 30

      - name: Publish tirith
        run: cargo publish -p tirith --locked
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
